name: Combined Pattern Scanner and Evaluator

on:
  schedule:
    # Run scanner every 15 minutes during market hours (9:30 AM - 4:00 PM ET)
    # GitHub Actions uses UTC time, so 9:30 AM ET = 2:30 PM UTC (during EST)
    # and 1:30 PM UTC during EDT
    - cron: '0,15,30,45 14-20 * * 1-5'  # EST: runs every 15 minutes
    - cron: '0,15,30,45 13-19 * * 1-5'  # EDT: runs every 15 minutes
    # Run evaluator at 4:30 PM ET (after market close)
    - cron: '30 21 * * 1-5'  # EST: 4:30 PM ET = 9:30 PM UTC
    - cron: '30 20 * * 1-5'  # EDT: 4:30 PM ET = 8:30 PM UTC
  
  workflow_dispatch:  # Allow manual trigger
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'scan'
        type: choice
        options:
          - scan
          - evaluate
          - both
          - end-of-day
      ticker:
        description: 'Stock ticker'
        required: true
        default: 'NVDA'
        type: string

jobs:
  setup-environment:
    runs-on: ubuntu-latest
    outputs:
      market-open: ${{ steps.check-market.outputs.is-open }}
    
    steps:
    - name: Check if market is open
      id: check-market
      run: |
        # Get current time in ET
        CURRENT_HOUR=$(TZ='America/New_York' date +%H)
        CURRENT_MIN=$(TZ='America/New_York' date +%M)
        CURRENT_DAY=$(TZ='America/New_York' date +%u)
        
        # Check if it's a weekday (1-5)
        if [ $CURRENT_DAY -gt 5 ]; then
          echo "is-open=false" >> $GITHUB_OUTPUT
          echo "Market is closed (weekend)"
          exit 0
        fi
        
        # Check if market hours (9:30 AM - 4:00 PM ET)
        CURRENT_TIME=$((CURRENT_HOUR * 60 + CURRENT_MIN))
        MARKET_OPEN=$((9 * 60 + 30))
        MARKET_CLOSE=$((16 * 60))
        
        if [ $CURRENT_TIME -ge $MARKET_OPEN ] && [ $CURRENT_TIME -lt $MARKET_CLOSE ]; then
          echo "is-open=true" >> $GITHUB_OUTPUT
          echo "Market is open"
        else
          echo "is-open=false" >> $GITHUB_OUTPUT
          echo "Market is closed"
        fi

  scan-patterns:
    needs: setup-environment
    if: |
      (github.event_name == 'schedule' && needs.setup-environment.outputs.market-open == 'true') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'scan' || github.event.inputs.action == 'both'))
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget build-essential git
        
        # Download and install TA-Lib from source
        wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
        tar -xzf ta-lib-0.4.0-src.tar.gz
        cd ta-lib/
        ./configure --prefix=/usr
        # Use single-threaded make to avoid race condition
        make
        sudo make install
        cd ..
        
        # Update library cache and create symlinks
        sudo ldconfig
        
        # Verify installation and fix library naming
        echo "Checking installed files..."
        ls -la /usr/lib/libta_lib* || echo "No libta_lib found in /usr/lib"
        ls -la /usr/lib/libta-lib* || echo "No libta-lib found in /usr/lib"
        ls -la /usr/include/ta-lib/ || echo "No headers found"
        
        # Create symlinks with both naming conventions
        if [ -f /usr/lib/libta_lib.so.0.0.0 ]; then
          sudo ln -sf /usr/lib/libta_lib.so.0.0.0 /usr/lib/libta_lib.so
          sudo ln -sf /usr/lib/libta_lib.so.0.0.0 /usr/lib/libta_lib.so.0
          # Also create hyphenated versions
          sudo ln -sf /usr/lib/libta_lib.so.0.0.0 /usr/lib/libta-lib.so
          sudo ln -sf /usr/lib/libta_lib.so.0.0.0 /usr/lib/libta-lib.so.0
        fi
        
        # Update library cache
        sudo ldconfig -v 2>/dev/null | grep -E 'ta_lib|ta-lib' || echo "Library not found in ldconfig"
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip wheel
        
        # Install all requirements except TA-Lib first
        grep -v "TA-Lib" requirements_pattern_scanner.txt > requirements_no_talib.txt
        pip install -r requirements_no_talib.txt
        
        # Install TA-Lib Python wrapper manually
        cd /tmp
        wget https://files.pythonhosted.org/packages/source/T/TA-Lib/ta_lib-0.6.4.tar.gz
        tar -xzf ta_lib-0.6.4.tar.gz
        cd ta_lib-0.6.4
        
        # Set environment variables
        export TA_INCLUDE_PATH=/usr/include
        export TA_LIBRARY_PATH=/usr/lib
        
        # Check if libraries exist
        echo "Looking for TA-Lib libraries..."
        find /usr -name "libta_lib*" -o -name "libta-lib*" 2>/dev/null || echo "No TA-Lib libraries found"
        
        # Build and install
        python setup.py build
        python setup.py install
        
        cd -
        
        # Verify both libraries are installed
        python -c "import talib; print(f'TA-Lib version: {talib.__version__}')"
        python -c "from tradingpatterns.tradingpatterns import detect_head_shoulder; print('TradingPatternScanner imported successfully')"
    
    - name: Create config directory and .env file
      run: |
        mkdir -p config
        cat > config/.env << EOF
        AZURE_STORAGE_ACCOUNT=${{ secrets.STORAGE_ACCOUNT_NAME }}
        AZURE_STORAGE_KEY=${{ secrets.ACCESS_KEY }}
        AZURE_CONTAINER_NAME=${{ secrets.CONTAINER_NAME }}
        EOF
    
    - name: Run combined pattern scanner
      run: |
        export LD_LIBRARY_PATH=/usr/lib:/usr/lib64:/usr/local/lib:$LD_LIBRARY_PATH
        python combined_pattern_scanner_gh.py
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: scan-logs
        path: |
          *.log
          signals_*.json
        if-no-files-found: warn

  evaluate-signals:
    needs: setup-environment
    if: |
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.action == 'evaluate' || github.event.inputs.action == 'both')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget build-essential git
        
        # Download and install TA-Lib from source
        wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
        tar -xzf ta-lib-0.4.0-src.tar.gz
        cd ta-lib/
        ./configure --prefix=/usr
        # Use single-threaded make to avoid race condition
        make
        sudo make install
        cd ..
        
        # Update library cache and create symlinks
        sudo ldconfig
        
        # Verify installation and fix library naming
        echo "Checking installed files..."
        ls -la /usr/lib/libta_lib* || echo "No libta_lib found in /usr/lib"
        ls -la /usr/lib/libta-lib* || echo "No libta-lib found in /usr/lib"
        ls -la /usr/include/ta-lib/ || echo "No headers found"
        
        # Create symlinks with both naming conventions
        if [ -f /usr/lib/libta_lib.so.0.0.0 ]; then
          sudo ln -sf /usr/lib/libta_lib.so.0.0.0 /usr/lib/libta_lib.so
          sudo ln -sf /usr/lib/libta_lib.so.0.0.0 /usr/lib/libta_lib.so.0
          # Also create hyphenated versions
          sudo ln -sf /usr/lib/libta_lib.so.0.0.0 /usr/lib/libta-lib.so
          sudo ln -sf /usr/lib/libta_lib.so.0.0.0 /usr/lib/libta-lib.so.0
        fi
        
        # Update library cache
        sudo ldconfig -v 2>/dev/null | grep -E 'ta_lib|ta-lib' || echo "Library not found in ldconfig"
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip wheel
        
        # Install all requirements except TA-Lib first
        grep -v "TA-Lib" requirements_pattern_scanner.txt > requirements_no_talib.txt
        pip install -r requirements_no_talib.txt
        
        # Install TA-Lib Python wrapper manually
        cd /tmp
        wget https://files.pythonhosted.org/packages/source/T/TA-Lib/ta_lib-0.6.4.tar.gz
        tar -xzf ta_lib-0.6.4.tar.gz
        cd ta_lib-0.6.4
        
        # Set environment variables
        export TA_INCLUDE_PATH=/usr/include
        export TA_LIBRARY_PATH=/usr/lib
        
        # Check if libraries exist
        echo "Looking for TA-Lib libraries..."
        find /usr -name "libta_lib*" -o -name "libta-lib*" 2>/dev/null || echo "No TA-Lib libraries found"
        
        # Build and install
        python setup.py build
        python setup.py install
        
        cd -
        
        # Verify both libraries are installed
        python -c "import talib; print(f'TA-Lib version: {talib.__version__}')"
        python -c "from tradingpatterns.tradingpatterns import detect_head_shoulder; print('TradingPatternScanner imported successfully')"
    
    - name: Create config directory and .env file
      run: |
        mkdir -p config
        cat > config/.env << EOF
        AZURE_STORAGE_ACCOUNT=${{ secrets.STORAGE_ACCOUNT_NAME }}
        AZURE_STORAGE_KEY=${{ secrets.ACCESS_KEY }}
        AZURE_CONTAINER_NAME=${{ secrets.CONTAINER_NAME }}
        EOF
    
    - name: Evaluate patterns
      run: |
        export LD_LIBRARY_PATH=/usr/lib:/usr/lib64:/usr/local/lib:$LD_LIBRARY_PATH
        python pattern_evaluator.py
    
    - name: Upload evaluation results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: evaluation-results
        path: |
          *.log
          evaluation_*.json
        if-no-files-found: warn

  end-of-day-evaluation:
    if: |
      (github.event_name == 'schedule' && 
      (contains(github.event.schedule, '30 21') || contains(github.event.schedule, '30 20'))) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'end-of-day')
    runs-on: ubuntu-latest
    # Run at 4:30 PM ET (after market close) or when manually triggered
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget build-essential git
        
        # Download and install TA-Lib from source
        wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
        tar -xzf ta-lib-0.4.0-src.tar.gz
        cd ta-lib/
        ./configure --prefix=/usr
        # Use single-threaded make to avoid race condition
        make
        sudo make install
        cd ..
        
        # Update library cache and create symlinks
        sudo ldconfig
        
        # Verify installation and fix library naming
        echo "Checking installed files..."
        ls -la /usr/lib/libta_lib* || echo "No libta_lib found in /usr/lib"
        ls -la /usr/lib/libta-lib* || echo "No libta-lib found in /usr/lib"
        ls -la /usr/include/ta-lib/ || echo "No headers found"
        
        # Create symlinks with both naming conventions
        if [ -f /usr/lib/libta_lib.so.0.0.0 ]; then
          sudo ln -sf /usr/lib/libta_lib.so.0.0.0 /usr/lib/libta_lib.so
          sudo ln -sf /usr/lib/libta_lib.so.0.0.0 /usr/lib/libta_lib.so.0
          # Also create hyphenated versions
          sudo ln -sf /usr/lib/libta_lib.so.0.0.0 /usr/lib/libta-lib.so
          sudo ln -sf /usr/lib/libta_lib.so.0.0.0 /usr/lib/libta-lib.so.0
        fi
        
        # Update library cache
        sudo ldconfig -v 2>/dev/null | grep -E 'ta_lib|ta-lib' || echo "Library not found in ldconfig"
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip wheel
        
        # Install all requirements except TA-Lib first
        grep -v "TA-Lib" requirements_pattern_scanner.txt > requirements_no_talib.txt
        pip install -r requirements_no_talib.txt
        
        # Install TA-Lib Python wrapper manually
        cd /tmp
        wget https://files.pythonhosted.org/packages/source/T/TA-Lib/ta_lib-0.6.4.tar.gz
        tar -xzf ta_lib-0.6.4.tar.gz
        cd ta_lib-0.6.4
        
        # Set environment variables
        export TA_INCLUDE_PATH=/usr/include
        export TA_LIBRARY_PATH=/usr/lib
        
        # Check if libraries exist
        echo "Looking for TA-Lib libraries..."
        find /usr -name "libta_lib*" -o -name "libta-lib*" 2>/dev/null || echo "No TA-Lib libraries found"
        
        # Build and install
        python setup.py build
        python setup.py install
        
        cd -
        
        # Verify both libraries are installed
        python -c "import talib; print(f'TA-Lib version: {talib.__version__}')"
        python -c "from tradingpatterns.tradingpatterns import detect_head_shoulder; print('TradingPatternScanner imported successfully')" matplotlib
    
    - name: Create config directory and .env file
      run: |
        mkdir -p config
        cat > config/.env << EOF
        AZURE_STORAGE_ACCOUNT=${{ secrets.STORAGE_ACCOUNT_NAME }}
        AZURE_STORAGE_KEY=${{ secrets.ACCESS_KEY }}
        AZURE_CONTAINER_NAME=${{ secrets.CONTAINER_NAME }}
        EOF
    
    - name: Run end-of-day comprehensive evaluation
      run: |
        echo "=== End of Day Pattern Evaluation ==="
        echo "Evaluating all patterns detected during today's trading session"
        export LD_LIBRARY_PATH=/usr/lib:/usr/lib64:/usr/local/lib:$LD_LIBRARY_PATH
        python pattern_evaluator.py
    
    - name: Create issue with daily report
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          const date = new Date().toISOString().split('T')[0];
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Pattern Scanner End-of-Day Evaluation - ${date}`,
            body: 'Today\'s pattern signals have been evaluated. Check the workflow logs for win rates and detailed results.',
            labels: ['automated', 'daily-report']
          });